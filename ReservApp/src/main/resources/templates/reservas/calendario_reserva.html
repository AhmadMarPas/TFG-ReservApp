<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/_common_head :: common_head(pageTitle='Calendario de Reserva', customLinks=~{:: #page-specific-links})}">
    <th:block id="page-specific-links">
        <style>
            .calendar-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            /* Estilos para períodos libres */
            .periodos-libres-container {
                background: white;
                border-radius: 12px;
                padding: 25px;
                margin-bottom: 30px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                border: 1px solid #e9ecef;
            }
            
            .periodos-libres-container h2 {
                color: #2c3e50;
                margin-bottom: 20px;
                font-weight: 600;
                font-size: 1.4em;
            }
            
            .fecha-seleccionada {
                background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                color: #1565c0;
                font-weight: 500;
                border-left: 4px solid #2196f3;
            }
            
            .periodos-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
                margin-bottom: 25px;
            }
            
            .periodo-libre-card {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border: 2px solid #dee2e6;
                border-radius: 10px;
                padding: 20px;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }
            
            .periodo-libre-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                border-color: #28a745;
            }
            
            .periodo-horario {
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 10px;
                font-size: 1.3em;
                font-weight: 600;
                color: #2c3e50;
            }
            
            .hora-inicio, .hora-fin {
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 5px 12px;
                border-radius: 5px;
                font-weight: 700;
            }
            
            .separador {
                margin: 0 10px;
                color: #6c757d;
                font-weight: bold;
            }
            
            .periodo-duracion {
                text-align: center;
                color: #6c757d;
                font-size: 0.9em;
                margin-bottom: 15px;
                font-style: italic;
            }
            
            .periodo-disponibilidad {
                text-align: center;
                margin-bottom: 15px;
                font-size: 0.9em;
            }
            
            .disponibilidad-ilimitada {
                color: #28a745;
                font-weight: 600;
            }
            
            .disponibilidad-limitada {
                color: #ffc107;
                font-weight: 600;
            }
            
            .btn-seleccionar-periodo {
                width: 100%;
                background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
                color: white;
                border: none;
                padding: 12px;
                border-radius: 6px;
                font-weight: 600;
                transition: all 0.3s ease;
                cursor: pointer;
            }
            
            .btn-seleccionar-periodo:hover {
                background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
                transform: translateY(-1px);
            }
            
            .periodo-personalizado-toggle {
                text-align: center;
                padding-top: 20px;
                border-top: 2px dashed #dee2e6;
            }
            
            .periodo-personalizado-toggle button {
                background: white;
                color: #007bff;
                border: 2px solid #007bff;
                padding: 12px 25px;
                border-radius: 25px;
                font-weight: 600;
                transition: all 0.3s ease;
            }
            
            .periodo-personalizado-toggle button:hover {
                background: #007bff;
                color: white;
                transform: translateY(-1px);
                box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
            }
            
            /* Responsive */
            @media (max-width: 768px) {
                .periodos-grid {
                    grid-template-columns: 1fr;
                }
                
                .periodo-horario {
                    font-size: 1.1em;
                }
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </th:block>
</head>

<body class="calendario-reserva">
    <div th:replace="~{fragments/_header :: header(pageTitle='Calendario de Reserva')}"></div>

    <div class="calendario-container">
        <h1 class="calendario-title">
            <i class="fas fa-calendar-alt"></i>
            Reservar en <span th:text="${establecimiento?.nombre ?: 'Establecimiento'}">Nombre Establecimiento</span>
        </h1>

        <!-- Mensajes de error y éxito -->
        <div th:if="${param.error}" class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            <span th:text="${param.error}">Error</span>
        </div>
        <div th:if="${error}" class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            <span th:text="${error}">Error</span>
        </div>
        <div th:if="${exito}" class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <span th:text="${exito}">Éxito</span>
        </div>

        <!-- Detalles del establecimiento -->
        <div class="establecimiento-details" th:if="${establecimiento}">
            <h2><i class="fas fa-store"></i> Detalles del Establecimiento</h2>
            <p><strong><i class="fas fa-map-marker-alt"></i> Dirección:</strong> 
               <span th:text="${establecimiento.direccion ?: 'No disponible'}">Dirección</span></p>
            <p><strong><i class="fas fa-phone"></i> Teléfono:</strong> 
               <span th:text="${establecimiento.telefono ?: 'No disponible'}">Teléfono</span></p>
            <p><strong><i class="fas fa-info-circle"></i> Estado:</strong> 
               <span th:text="${establecimiento.activo ? 'Activo' : 'Inactivo'}" 
                     th:class="${establecimiento.activo ? 'text-success' : 'text-danger'}">Estado</span></p>
            
            <!-- NUEVA SECCIÓN: Información de aforo -->
            <div class="aforo-info" th:if="${establecimiento.aforo != null and establecimiento.aforo > 0}">
                <div class="aforo-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="aforo-text">
                    <strong>Aforo máximo:</strong> 
                    <span class="aforo-numero" th:text="${establecimiento.aforo}">1</span> 
                    <span th:text="${establecimiento.aforo == 1 ? 'persona' : 'personas'}">persona</span> por horario
                </div>
            </div>
            
            <div class="aforo-info" th:if="${establecimiento.aforo == null or establecimiento.aforo <= 0}" 
                 style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-color: #007bff;">
                <div class="aforo-icon" style="color: #007bff;">
                    <i class="fas fa-infinity"></i>
                </div>
                <div class="aforo-text">
                    <strong>Sin límite de aforo</strong> - Múltiples personas pueden reservar el mismo horario
                </div>
            </div>
        </div>

        <!-- Franjas horarias -->
        <div class="franjas-horarias" 
             th:if="${establecimiento?.activo and franjasHorarias != null and !franjasHorarias.isEmpty()}">
            <h3><i class="fas fa-clock"></i> Horario de Apertura</h3>
            <ul>
                <li th:each="franja : ${franjasHorarias}"
                    th:if="${franja != null}">
                    <i class="fas fa-calendar-day"></i>
                    <span th:text="${T(es.ubu.reservapp.util.FechaUtil).formatearDiaSemana(franja.diaSemana) + ': ' + franja.horaInicio + ' - ' + franja.horaFin}">
                        Lunes: 09:00 - 17:00
                    </span>
                </li>
            </ul>
        </div>

        <!-- Mensaje de advertencia -->
        <div class="alert alert-warning" 
             th:if="${establecimiento == null or !establecimiento.activo or franjasHorarias == null or franjasHorarias.isEmpty()}">
            <i class="fas fa-exclamation-triangle"></i>
            Este establecimiento no está disponible actualmente o no tiene horarios definidos. 
            No se pueden realizar reservas en este momento.
        </div>

        <!-- Sección de Reservas del Usuario -->
        <div class="reservas-usuario-container" th:if="${establecimiento?.activo}">
            <h2><i class="fas fa-bookmark"></i> Mis Reservas en este Establecimiento</h2>
            
            <!-- Reservas Futuras -->
            <div class="reservas-futuras">
                <h3><i class="fas fa-calendar-day"></i> Próximas Reservas</h3>
                <div class="reservas-scroll-container">
                    <div id="reservas-futuras-container">
                        <!-- Las reservas se cargarán dinámicamente aquí -->
                    </div>
                    <div id="loading-futuras" class="loading-indicator" style="display: none;">
                        <div class="loading-spinner"></div>
                        Cargando más reservas...
                    </div>
                    <div id="empty-futuras" class="alert alert-info" style="display: none;">
                        <i class="fas fa-info-circle"></i> No tienes reservas futuras en este establecimiento.
                    </div>
                    <div id="no-more-futuras" class="no-more-data" style="display: none;">
                        <i class="fas fa-check-circle"></i> No hay más reservas futuras
                    </div>
                </div>
            </div>
            
            <!-- Reservas Pasadas -->
            <div class="reservas-pasadas">
                <h3><i class="fas fa-history"></i> Reservas Anteriores</h3>
                <div class="reservas-scroll-container">
                    <div id="reservas-pasadas-container">
                        <!-- Las reservas se cargarán dinámicamente aquí -->
                    </div>
                    <div id="loading-pasadas" class="loading-indicator" style="display: none;">
                        <div class="loading-spinner"></div>
                        Cargando más reservas...
                    </div>
                    <div id="empty-pasadas" class="alert alert-info" style="display: none;">
                        <i class="fas fa-info-circle"></i> No tienes reservas anteriores en este establecimiento.
                    </div>
                    <div id="no-more-pasadas" class="no-more-data" style="display: none;">
                        <i class="fas fa-check-circle"></i> No hay más reservas anteriores
                    </div>
                </div>
	        </div>
        </div>

        <!-- Períodos libres para fecha preseleccionada -->
        <div th:if="${periodosLibres != null and #lists.size(periodosLibres) > 0}" 
             class="periodos-libres-container">
            <h2><i class="fas fa-clock"></i> Períodos Disponibles</h2>
            <p class="fecha-seleccionada">
                <i class="fas fa-calendar-day"></i> 
                Fecha seleccionada: <strong th:text="${fechaFormateada != null ? fechaFormateada : fechaPreseleccionada}">01/01/2024</strong>
            </p>
            
            <div class="periodos-grid">
                <div th:each="periodo : ${periodosLibres}" class="periodo-libre-card">
                    <div class="periodo-horario">
                        <span class="hora-inicio" th:text="${periodo.horaInicioFormateada}">09:00</span>
                        <span class="separador">-</span>
                        <span class="hora-fin" th:text="${periodo.horaFinFormateada}">10:30</span>
                    </div>
                    <div class="periodo-duracion" th:text="${periodo.duracionFormateada}">1h 30min</div>
                    <div class="periodo-disponibilidad">
                        <span th:if="${periodo.ilimitado}" class="disponibilidad-ilimitada">
                            <i class="fas fa-infinity"></i> Disponibilidad ilimitada
                        </span>
                        <span th:unless="${periodo.ilimitado}" class="disponibilidad-limitada">
                            <i class="fas fa-users"></i> 
                            <span th:text="${periodo.espaciosDisponibles}">5</span> espacios disponibles
                        </span>
                    </div>
                    <button type="button" class="btn-seleccionar-periodo" 
                            th:data-hora-inicio="${periodo.horaInicioFormateada}"
                            th:data-hora-fin="${periodo.horaFinFormateada}">
                        <i class="fas fa-check"></i> Seleccionar período
                    </button>
                </div>
            </div>
            
            <div class="periodo-personalizado-toggle">
                <button type="button" id="togglePersonalizado" class="btn btn-outline-primary">
                    <i class="fas fa-edit"></i> O personalizar horario manualmente
                </button>
            </div>
        </div>

        <!-- Formulario de reserva -->
        <form th:action="@{/misreservas/crear}" 
              th:object="${reserva}" 
              method="post" 
              id="reservaForm"
              th:if="${establecimiento?.activo and franjasHorarias != null and !franjasHorarias.isEmpty()}">
            
            <input type="hidden" name="establecimientoId" th:value="${establecimiento.id}" />

            <div class="form-group">
                <label for="fecha">
                    <i class="fas fa-calendar"></i> Fecha de la Reserva:
                </label>
                <input type="date" 
                       id="fecha" 
                       name="fecha" 
                       required="required"
                       th:value="${fechaPreseleccionada}"
                       th:min="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}">
            </div>
            <!-- NUEVA SECCIÓN: Leyenda de disponibilidad para slots predefinidos -->
            <div th:if="${requiereSlotsPredefinidos}" class="disponibilidad-leyenda">
                <h5><i class="fas fa-info-circle"></i> Leyenda de Disponibilidad</h5>
                <div class="leyenda-items">
                    <div class="leyenda-item">
                        <div class="leyenda-color leyenda-disponible"></div>
                        <span>Disponible</span>
                    </div>
                    <div class="leyenda-item">
                        <div class="leyenda-color leyenda-ocupado"></div>
                        <span>Sin disponibilidad</span>
                    </div>
                    <div class="leyenda-item">
                        <div class="leyenda-color leyenda-seleccionado"></div>
                        <span>Seleccionado</span>
                    </div>
                </div>
            </div>

            <!-- Campos de hora para establecimientos sin duración fija -->
            <div th:if="${!requiereSlotsPredefinidos}">
                <div class="form-group">
                    <label for="horaInicio">
                        <i class="fas fa-clock"></i> Hora de Inicio:
                    </label>
                    <input type="time" 
                           id="horaInicio" 
                           name="horaInicio" 
                           required="required">
                </div>

                <div class="form-group">
                    <label for="horaFin">
                        <i class="fas fa-clock"></i> Hora de Fin:
                    </label>
                    <input type="time" 
                           id="horaFin" 
                           name="horaFin" 
                           required="required">
                </div>
            </div>

            <!-- Selector de slots para establecimientos con duración fija -->
            <div th:if="${requiereSlotsPredefinidos}">
                <div class="form-group">
                    <label for="slotSeleccionado">
                        <i class="fas fa-clock"></i> Horario Disponible:
                    </label>
                    <select id="slotSeleccionado" 
                            name="slotSeleccionado" 
                            required="required"
                            class="form-control">
                        <option value="">Seleccione primero una fecha</option>
                    </select>
                    <small class="form-text text-muted">
                        Los horarios disponibles se mostrarán según el día seleccionado.
                        Duración de cada reserva: <span th:text="${establecimiento.duracionReserva}">30</span> minutos.
                    </small>
                </div>
            </div>

            <!-- Sección de Convocatoria -->
            <div class="convocatoria-section">
                <h3><i class="fas fa-users"></i> Convocatoria de Reunión</h3>
                <p class="text-muted">Opcional: Invite a otros usuarios a esta reserva</p>
                
                <div class="form-group">
                    <label for="enlaceReunion">
                        <i class="fas fa-link"></i> Enlace de la Reunión:
                    </label>
                    <input type="url" 
                           id="enlaceReunion" 
                           name="enlaceReunion" 
                           class="form-control"
                           placeholder="https://meet.google.com/abc-defg-hij o https://zoom.us/j/123456789">
                    <small class="form-text text-muted">
                        Enlace para la videoconferencia (Google Meet, Zoom, Teams, etc.)
                    </small>
                </div>

                <div class="form-group">
                    <label for="observaciones">
                        <i class="fas fa-sticky-note"></i> Observaciones:
                    </label>
                    <textarea id="observaciones" 
                              name="observaciones" 
                              class="form-control"
                              rows="3"
                              placeholder="Temas a tratar, agenda de la reunión, notas adicionales..."></textarea>
                </div>

                <div class="form-group">
                    <label for="buscarUsuarios">
                        <i class="fas fa-search"></i> Buscar Usuarios para Invitar:
                    </label>
                    <div class="usuario-search-container">
                        <input type="text" 
                               id="buscarUsuarios" 
                               class="form-control"
                               placeholder="Escriba nombre, apellido, ID o email del usuario...">
                        <div id="resultadosBusqueda" class="search-results"></div>
                    </div>
                    <small class="form-text text-muted">
                        Escriba al menos 2 caracteres para buscar usuarios
                    </small>
                </div>

                <div class="form-group">
                    <label for="usuariosSeleccionados"><i class="fas fa-user-friends"></i> Usuarios Invitados:</label>
                    <div id="usuariosSeleccionados" class="usuarios-seleccionados">
                        <p class="text-muted">No hay usuarios seleccionados</p>
                    </div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Procesando reserva...</p>
            </div>

            <button type="submit" class="btn btn-submit" id="submitBtn">
                <i class="fas fa-check"></i> Confirmar Reserva
            </button>
        </form>
        
        <!-- Enlaces de navegación -->
        <div class="back-links">
            <a th:href="@{/misreservas}" class="back-link">
                <i class="fas fa-arrow-left"></i> Volver a Mis Reservas
            </a>
            <a th:href="@{/menuprincipal}" class="back-link">
                <i class="fas fa-home"></i> Menú Principal
            </a>
        </div>
    </div>

    <!-- Scripts -->
    <script th:src="@{~/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // Variables del servidor
            const requiereSlotsPredefinidos = /*[[${requiereSlotsPredefinidos}]]*/ false;
            const fechaPreseleccionada = /*[[${fechaPreseleccionada}]]*/ null;
            
            // Configurar fecha mínima y valor preseleccionado
            const fechaInput = document.getElementById('fecha');
            if (fechaInput) {
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                fechaInput.setAttribute('min', todayString);
                
                console.log('Campo fecha encontrado. Valor inicial:', fechaInput.value);
                console.log('Fecha preseleccionada del servidor:', fechaPreseleccionada);
                
                // Si requiere slots predefinidos, manejar cambio de fecha
                if (requiereSlotsPredefinidos) {
                    fechaInput.addEventListener('change', function() {
                        actualizarSlotsDisponibles();
                    });
                }
                
                // Establecer fecha preseleccionada si existe
                if (fechaPreseleccionada) {
                    fechaInput.value = fechaPreseleccionada;
                    // Disparar evento change para actualizar otros componentes
                    fechaInput.dispatchEvent(new Event('change'));
                    console.log('Fecha preseleccionada establecida. Nuevo valor:', fechaInput.value);
                    
                    // Si requiere slots predefinidos, cargar automáticamente los slots para la fecha preseleccionada
                    if (requiereSlotsPredefinidos) {
                        console.log('Establecimiento requiere slots predefinidos - cargando slots para fecha preseleccionada');
                        actualizarSlotsDisponibles();
                    }
                } else {
                    console.log('No hay fecha preseleccionada para establecer');
                }
            }
            
            // Función para actualizar slots disponibles según la fecha
            function actualizarSlotsDisponibles() {
                const fechaSeleccionada = document.getElementById('fecha').value;
                const slotSelect = document.getElementById('slotSeleccionado');
                
                if (!fechaSeleccionada || !slotSelect) return;
                
                // Mostrar indicador de carga
                slotSelect.innerHTML = '<option value="">Cargando horarios...</option>';
                slotSelect.disabled = true;
                
                // Obtener el ID del establecimiento
                const establecimientoId = document.querySelector('input[name="establecimientoId"]').value;
                
                // Realizar petición AJAX al endpoint
                fetch(`/misreservas/slots-disponibles?establecimientoId=${establecimientoId}&fecha=${fechaSeleccionada}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error al obtener slots disponibles');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Limpiar opciones existentes
                        slotSelect.innerHTML = '<option value="">Seleccione un horario</option>';
                        
                        if (data.slots && data.slots.length > 0) {
                            // Obtener fecha y hora actual para validar horarios pasados
                            const ahora = new Date();
                            const fechaSeleccionadaDate = new Date(fechaSeleccionada);
                            const esHoy = fechaSeleccionadaDate.toDateString() === ahora.toDateString();
                            
                            data.slots.forEach(function(slot) {
                                const option = document.createElement('option');
                                option.value = slot.etiqueta;
                                
                                let disponible = slot.disponible;
                                let razonNoDisponible = '';
                                
                                // Verificar si es hoy y el horario ya pasó
                                if (esHoy && disponible) {
                                    // Extraer hora de inicio del slot (formato "HH:MM - HH:MM")
                                    const horaInicioMatch = slot.etiqueta.match(/^(\d{2}:\d{2})/);
                                    if (horaInicioMatch) {
                                        const horaInicio = horaInicioMatch[1];
                                        const [horas, minutos] = horaInicio.split(':').map(Number);
                                        const horaSlot = new Date();
                                        horaSlot.setHours(horas, minutos, 0, 0);
                                        
                                        if (horaSlot <= ahora) {
                                            disponible = false;
                                            razonNoDisponible = 'Horario pasado';
                                        }
                                    }
                                }
                                
                                // Configurar texto y disponibilidad
                                if (disponible) {
                                    option.textContent = slot.etiqueta;
                                    if (data.tieneAforo) {
                                        option.textContent += ` (${slot.infoDisponibilidad})`;
                                    }
                                } else {
                                    const motivo = razonNoDisponible || 'Sin disponibilidad';
                                    option.textContent = `${slot.etiqueta} - ${motivo}`;
                                    option.disabled = true;
                                    option.classList.add('slot-ocupado');
                                }
                                
                                slotSelect.appendChild(option);
                            });
                        } else {
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = 'No hay horarios disponibles para este día';
                            option.disabled = true;
                            slotSelect.appendChild(option);
                        }
                        
                        // Habilitar el select
                        slotSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error al cargar slots:', error);
                        slotSelect.innerHTML = '<option value="">Error al cargar horarios</option>';
                        slotSelect.disabled = false;
                    });
            }

            // Manejar envío del formulario
            const form = document.getElementById('reservaForm');
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');

            if (form && submitBtn && loading) {
                form.addEventListener('submit', function(e) {
                    const fecha = document.getElementById('fecha').value;
                    
                    if (!fecha) {
                        e.preventDefault();
                        alert('Por favor, seleccione una fecha.');
                        return;
                    }
                    
                    if (requiereSlotsPredefinidos) {
                        // Validación para slots predefinidos
                        const slotSeleccionado = document.getElementById('slotSeleccionado').value;
                        if (!slotSeleccionado) {
                            e.preventDefault();
                            alert('Por favor, seleccione un horario.');
                            return;
                        }
                    } else {
                        // Validación para horas libres
                        const horaInicio = document.getElementById('horaInicio').value;
                        const horaFin = document.getElementById('horaFin').value;

                        if (!horaInicio || !horaFin) {
                            e.preventDefault();
                            alert('Por favor, complete todos los campos requeridos.');
                            return;
                        }

                        // Validar que la hora de fin sea posterior a la hora de inicio
                        if (horaInicio >= horaFin) {
                            e.preventDefault();
                            alert('La hora de fin debe ser posterior a la hora de inicio.');
                            return;
                        }
                    }

                    // Mostrar loading
                    submitBtn.style.display = 'none';
                    loading.style.display = 'block';
                });
            }

            // Auto-ocultar alertas después de 5 segundos
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    alert.style.opacity = '0';
                    setTimeout(function() {
                        alert.style.display = 'none';
                    }, 300);
                }, 5000);
            });

            // Funcionalidad de búsqueda de usuarios
        initUsuarioSearch();
    });

    // Función para mostrar/ocultar detalles de reservas
    function toggleDetalles(reservaId) {
        const detalles = document.getElementById('detalles-' + reservaId);
        if (detalles) {
            if (detalles.style.display === 'none' || detalles.style.display === '') {
                detalles.style.display = 'block';
            } else {
                detalles.style.display = 'none';
            }
        }
    }
    
    function editarReserva(reservaId) {
        // Redirigir a la página de edición
        window.location.href = '/misreservas/editar/' + reservaId;
    }

    // Variables globales para manejo de usuarios
    let usuariosSeleccionados = [];
    let timeoutBusqueda;

        function initUsuarioSearch() {
            const buscarInput = document.getElementById('buscarUsuarios');
            const resultadosDiv = document.getElementById('resultadosBusqueda');

            if (buscarInput && resultadosDiv) {
                buscarInput.addEventListener('input', function() {
                    const query = this.value.trim();
                    
                    // Limpiar timeout anterior
                    clearTimeout(timeoutBusqueda);
                    
                    if (query.length < 2) {
                        resultadosDiv.innerHTML = '';
                        resultadosDiv.style.display = 'none';
                        return;
                    }
                    
                    // Debounce: esperar 300ms antes de buscar
                    timeoutBusqueda = setTimeout(() => {
                        buscarUsuarios(query);
                    }, 300);
                });

                // Ocultar resultados al hacer clic fuera
                document.addEventListener('click', function(e) {
                    if (!buscarInput.contains(e.target) && !resultadosDiv.contains(e.target)) {
                        resultadosDiv.style.display = 'none';
                    }
                });
            }
        }

        function buscarUsuarios(query) {
            const resultadosDiv = document.getElementById('resultadosBusqueda');
            
            fetch(`/misreservas/buscar-usuarios?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(usuarios => {
                    mostrarResultadosBusqueda(usuarios);
                })
                .catch(error => {
                    console.error('Error al buscar usuarios:', error);
                    resultadosDiv.innerHTML = '<div class="search-item error">Error al buscar usuarios</div>';
                    resultadosDiv.style.display = 'block';
                });
        }

        function mostrarResultadosBusqueda(usuarios) {
            const resultadosDiv = document.getElementById('resultadosBusqueda');
            
            if (usuarios.length === 0) {
                resultadosDiv.innerHTML = '<div class="search-item no-results">No se encontraron usuarios</div>';
            } else {
                const html = usuarios.map(usuario => {
                    const yaSeleccionado = usuariosSeleccionados.some(u => u.id === usuario.id);
                    const claseDisabled = yaSeleccionado ? 'disabled' : '';
                    const textoDisabled = yaSeleccionado ? ' (ya seleccionado)' : '';
                    
                    return `
                        <div class="search-item ${claseDisabled}" onclick="${yaSeleccionado ? '' : `seleccionarUsuario('${usuario.id}', '${usuario.nombre}', '${usuario.correo}')`}">
                            <div class="usuario-info">
                                <strong>${usuario.nombre}</strong>
                                <small>${usuario.correo}</small>
                                <span class="usuario-id">ID: ${usuario.id}</span>
                            </div>
                            ${textoDisabled}
                        </div>
                    `;
                }).join('');
                resultadosDiv.innerHTML = html;
            }
            
            resultadosDiv.style.display = 'block';
        }

        function seleccionarUsuario(id, nombre, correo) {
            // Verificar si ya está seleccionado
            if (usuariosSeleccionados.some(u => u.id === id)) {
                return;
            }
            
            // Agregar usuario a la lista
            usuariosSeleccionados.push({ id, nombre, correo });
            
            // Actualizar vista
            actualizarUsuariosSeleccionados();
            
            // Limpiar búsqueda
            document.getElementById('buscarUsuarios').value = '';
            document.getElementById('resultadosBusqueda').style.display = 'none';
        }

        function removerUsuario(id) {
            usuariosSeleccionados = usuariosSeleccionados.filter(u => u.id !== id);
            actualizarUsuariosSeleccionados();
        }

        function actualizarUsuariosSeleccionados() {
            const container = document.getElementById('usuariosSeleccionados');
            
            if (usuariosSeleccionados.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay usuarios seleccionados</p>';
            } else {
                const html = usuariosSeleccionados.map(usuario => `
                    <div class="usuario-seleccionado">
                        <div class="usuario-info">
                            <strong>${usuario.nombre}</strong>
                            <small>${usuario.correo}</small>
                            <span class="usuario-id">ID: ${usuario.id}</span>
                        </div>
                        <button type="button" class="btn-remove" onclick="removerUsuario('${usuario.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                        <input type="hidden" name="usuariosConvocados" value="${usuario.id}">
                    </div>
                `).join('');
                container.innerHTML = html;
            }
        }
        
        // Variables para scroll infinito
        let paginaFuturas = 1;
        let paginaPasadas = 1;
        const tamañoPagina = 5;
        let cargandoFuturas = false;
        let cargandoPasadas = false;
        let hayMasFuturas = true;
        let hayMasPasadas = true;
        
        // Función para cargar reservas con scroll infinito
        function cargarReservasScroll(tipo, pagina, esInicial = false) {
            const establecimientoInput = document.querySelector('input[name="establecimientoId"]');
            if (!establecimientoInput) return;
            const establecimientoId = establecimientoInput.value;
            if (!establecimientoId) return;
            
            const esFuturas = tipo === 'futuras';
            const loading = document.getElementById(esFuturas ? 'loading-futuras' : 'loading-pasadas');
            const container = document.getElementById(esFuturas ? 'reservas-futuras-container' : 'reservas-pasadas-container');
            const empty = document.getElementById(esFuturas ? 'empty-futuras' : 'empty-pasadas');
            const noMore = document.getElementById(esFuturas ? 'no-more-futuras' : 'no-more-pasadas');
            
            if (esFuturas) {
                if (cargandoFuturas) return;
                cargandoFuturas = true;
            } else {
                if (cargandoPasadas) return;
                cargandoPasadas = true;
            }
            
            loading.style.display = 'block';
            
            const params = new URLSearchParams({
                establecimientoId: establecimientoId,
                paginaFuturas: esFuturas ? pagina : 1,
                paginaPasadas: esFuturas ? 1 : pagina,
                tamañoPagina: tamañoPagina
            });
            
            fetch(`/misreservas/reservas-paginadas?${params}`)
                .then(response => response.json())
                .then(data => {
                    const reservas = esFuturas ? data.reservasFuturas : data.reservasPasadas;
                    const hayMas = esFuturas ? data.hayMasReservasFuturas : data.hayMasReservasPasadas;
                    
                    if (esFuturas) {
                        hayMasFuturas = hayMas;
                    } else {
                        hayMasPasadas = hayMas;
                    }
                    
                    if (esInicial) {
                        container.innerHTML = '';
                        if (reservas.length === 0) {
                            empty.style.display = 'block';
                        } else {
                            empty.style.display = 'none';
                        }
                    }
                    
                    if (reservas.length > 0) {
                        reservas.forEach(reserva => {
                            const reservaHtml = crearReservaHTML(reserva, esFuturas);
                            container.insertAdjacentHTML('beforeend', reservaHtml);
                        });
                    }
                    
                    if (!hayMas) {
                        noMore.style.display = 'block';
                    }
                    
                    loading.style.display = 'none';
                    
                    if (esFuturas) {
                        cargandoFuturas = false;
                    } else {
                        cargandoPasadas = false;
                    }
                })
                .catch(error => {
                    console.error('Error cargando reservas:', error);
                    loading.style.display = 'none';
                    if (esFuturas) {
                        cargandoFuturas = false;
                    } else {
                        cargandoPasadas = false;
                    }
                });
        }
        
        // Función para crear HTML de una reserva
        function crearReservaHTML(reserva, esFutura) {
            const fechaFormateada = new Date(reserva.fechaReserva).toLocaleDateString('es-ES');
            const horaFormateada = new Date(reserva.fechaReserva).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
            const horaCompleta = reserva.horaFin ? `${horaFormateada} - ${reserva.horaFin}` : horaFormateada;
            
            const acciones = esFutura ? `
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleDetalles(${reserva.id})">
                    <i class="fas fa-eye"></i> Ver detalles
                </button>
                <form action="/misreservas/editar/${reserva.id}" method="get" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-warning">
                        <i class="fas fa-edit"></i> Modificar
                    </button>
                </form>
                <button type="button" class="btn btn-sm btn-danger" onclick="confirmarAnulacion(${reserva.id})">
                    <i class="fas fa-times-circle"></i> Anular
                </button>
            ` : `
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleDetalles(${reserva.id})">
                    <i class="fas fa-eye"></i> Ver detalles
                </button>
            `;
            
            let convocatoriaHTML = '';
            if (reserva.convocatoria) {
                const enlaceHTML = reserva.convocatoria.enlace ? 
                    `<p><strong><i class="fas fa-link"></i> Enlace:</strong> <a href="${reserva.convocatoria.enlace}" target="_blank">${reserva.convocatoria.enlace}</a></p>` : '';
                const observacionesHTML = reserva.convocatoria.observaciones ? 
                    `<p><strong><i class="fas fa-sticky-note"></i> Observaciones:</strong> ${reserva.convocatoria.observaciones}</p>` : '';
                
                let usuariosHTML = '';
                if (reserva.convocatoria.convocados && reserva.convocatoria.convocados.length > 0) {
                    const usuariosList = reserva.convocatoria.convocados.map(convocado => 
                        `<li>${convocado.usuario.nombre} ${convocado.usuario.apellidos} (${convocado.usuario.correo})</li>`
                    ).join('');
                    usuariosHTML = `
                        <div class="usuarios-convocados">
                            <p><strong><i class="fas fa-users"></i> Usuarios convocados:</strong></p>
                            <ul class="lista-usuarios">${usuariosList}</ul>
                        </div>
                    `;
                }
                
                convocatoriaHTML = `
                    <div class="convocatoria-info">
                        ${enlaceHTML}
                        ${observacionesHTML}
                        ${usuariosHTML}
                    </div>
                `;
            } else {
                convocatoriaHTML = '<div class="sin-convocatorias"><p class="text-muted"><i class="fas fa-info-circle"></i> Esta reserva no tiene convocatoria asociada.</p></div>';
            }
            
            return `
                <div class="reserva-item ${esFutura ? 'reserva-futura' : 'reserva-pasada'}">
                    <div class="reserva-header">
                        <div class="reserva-info-basica">
                            <div class="reserva-fecha">
                                <i class="fas fa-calendar-alt"></i>
                                <span>${fechaFormateada}</span>
                            </div>
                            <div class="reserva-hora">
                                <i class="fas fa-clock"></i>
                                <span>${horaCompleta}</span>
                            </div>
                        </div>
                        <div class="reserva-acciones">
                            ${acciones}
                        </div>
                    </div>
                    <div class="reserva-detalles" id="detalles-${reserva.id}" style="display: none;">
                        ${convocatoriaHTML}
                    </div>
                </div>
            `;
        }
        
        // Event listeners para scroll infinito
        function setupScrollListeners() {
            const futurasContainer = document.querySelector('#reservas-futuras-container').closest('.reservas-scroll-container');
            const pasadasContainer = document.querySelector('#reservas-pasadas-container').closest('.reservas-scroll-container');
            
            futurasContainer.addEventListener('scroll', function() {
                if (this.scrollTop + this.clientHeight >= this.scrollHeight - 10) {
                    if (hayMasFuturas && !cargandoFuturas) {
                        paginaFuturas++;
                        cargarReservasScroll('futuras', paginaFuturas);
                    }
                }
            });
            
            pasadasContainer.addEventListener('scroll', function() {
                if (this.scrollTop + this.clientHeight >= this.scrollHeight - 10) {
                    if (hayMasPasadas && !cargandoPasadas) {
                        paginaPasadas++;
                        cargarReservasScroll('pasadas', paginaPasadas);
                    }
                }
            });
        }
        
        // Inicializar cuando cambie el establecimiento
        document.addEventListener('DOMContentLoaded', function() {
            setupScrollListeners();
            
            const establecimientoSelect = document.getElementById('establecimientoSelect');
            if (establecimientoSelect) {
                establecimientoSelect.addEventListener('change', function() {
                    if (this.value) {
                        // Resetear variables
                        paginaFuturas = 1;
                        paginaPasadas = 1;
                        hayMasFuturas = true;
                        hayMasPasadas = true;
                        
                        // Ocultar mensajes
                        document.getElementById('no-more-futuras').style.display = 'none';
                        document.getElementById('no-more-pasadas').style.display = 'none';
                        
                        // Cargar primera página
                        cargarReservasScroll('futuras', 1, true);
                        cargarReservasScroll('pasadas', 1, true);
                    }
                });
                // Cargar reservas si ya hay un establecimiento seleccionado
                if (establecimientoSelect.value) {
                    cargarReservasScroll('futuras', 1, true);
                    cargarReservasScroll('pasadas', 1, true);
                }
            }
        });
        
        // Función para confirmar y anular reserva
        function confirmarAnulacion(reservaId) {
            if (confirm('¿Está seguro de que desea anular esta reserva? Esta acción no se puede deshacer y se enviará una notificación por correo a todos los involucrados.')) {
                // Crear formulario para enviar la petición POST
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/misreservas/anular/' + reservaId;
                
                // Se agrega token para CSRF
                const csrfToken = document.querySelector('meta[name="_csrf"]');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
                if (csrfToken && csrfHeader) {
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = '_csrf';
                    csrfInput.value = csrfToken.getAttribute('content');
                    form.appendChild(csrfInput);
                }
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // Función para seleccionar un período libre
        function seleccionarPeriodo(horaInicio, horaFin) {
            // Establecer las horas en el formulario
            const horaInicioInput = document.getElementById('horaInicio');
            const horaFinInput = document.getElementById('horaFin');
            
            if (horaInicioInput && horaFinInput) {
                horaInicioInput.value = horaInicio;
                horaFinInput.value = horaFin;
                
                // Ocultar la sección de períodos libres y mostrar el formulario
                const periodosContainer = document.querySelector('.periodos-libres-container');
                const formularioContainer = document.getElementById('reservaForm');
                
                if (periodosContainer) {
                    periodosContainer.style.display = 'none';
                }
                
                if (formularioContainer) {
                    formularioContainer.style.display = 'block';
                    formularioContainer.scrollIntoView({ behavior: 'smooth' });
                }
                
                // Resaltar los campos seleccionados
                horaInicioInput.style.backgroundColor = '#e3f2fd';
                horaFinInput.style.backgroundColor = '#e3f2fd';
                
                // Mostrar mensaje de confirmación
                mostrarMensaje('Período seleccionado: ' + horaInicio + ' - ' + horaFin, 'success');
            }
        }
        
        // Función para mostrar formulario personalizado
        function mostrarFormularioPersonalizado() {
            const periodosContainer = document.querySelector('.periodos-libres-container');
            const formularioContainer = document.getElementById('reservaForm');
            
            if (periodosContainer) {
                periodosContainer.style.display = 'none';
            }
            
            if (formularioContainer) {
                formularioContainer.style.display = 'block';
                formularioContainer.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Función para mostrar mensajes temporales
        function mostrarMensaje(mensaje, tipo) {
            // Crear elemento del mensaje
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'info-circle'}"></i>
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insertar al principio del contenedor principal
            const container = document.querySelector('.calendario-container');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
                
                // Auto-ocultar después de 3 segundos
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            }
        }
        
        // Inicializar scroll infinito cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            setupScrollListeners();
            // Cargar las primeras reservas
            cargarReservasScroll('futuras', 1, true);
            cargarReservasScroll('pasadas', 1, true);
            
            // Configurar toggle de formulario personalizado
            const toggleBtn = document.getElementById('togglePersonalizado');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', mostrarFormularioPersonalizado);
            }
            
            // Si hay períodos libres, inicialmente ocultar el formulario
            const periodosContainer = document.querySelector('.periodos-libres-container');
            const formularioContainer = document.getElementById('reservaForm');
            
            if (periodosContainer && formularioContainer) {
                formularioContainer.style.display = 'none';
            }
            
            // Agregar event listeners para botones de períodos libres
            document.querySelectorAll('.btn-seleccionar-periodo').forEach(function(button) {
                button.addEventListener('click', function() {
                    const horaInicio = this.getAttribute('data-hora-inicio');
                    const horaFin = this.getAttribute('data-hora-fin');
                    
                    if (horaInicio && horaFin) {
                        console.log('Período seleccionado:', horaInicio, '-', horaFin);
                        seleccionarPeriodo(horaInicio, horaFin);
                    }
                });
            });
        });
    </script>
</body>
</html>