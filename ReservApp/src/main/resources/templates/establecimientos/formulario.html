<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Establecimiento</title>
    <link rel="stylesheet" th:href="@{~/webjars/bootstrap/css/bootstrap.min.css}" />
</head>
<body>
<div class="container mt-5">
    <h1 th:if="${establecimiento.id == null}">Nuevo Establecimiento</h1>
    <h1 th:unless="${establecimiento.id == null}">Editar Establecimiento</h1>

    <form th:action="@{/admin/establecimientos/guardar}" th:object="${establecimiento}" method="post" class="mt-4">
        <!-- Campo oculto para el ID si es una edición -->
        <input type="hidden" th:field="*{id}" />

        <div class="mb-3">
            <label for="nombre" class="form-label">Nombre:</label>
            <input type="text" th:field="*{nombre}" class="form-control" id="nombre" placeholder="Nombre del establecimiento" required />
            <div class="alert alert-warning" th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}">Error en el nombre</div>
        </div>

        <div class="mb-3">
            <label for="descripcion" class="form-label">Descripción:</label>
            <textarea th:field="*{descripcion}" class="form-control" id="descripcion" rows="3" placeholder="Descripción del establecimiento" required></textarea>
            <div class="alert alert-warning" th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}">Error en la descripción</div>
        </div>

        <!-- Gestión de Franjas Horarias -->
        <hr class="my-4">
        <h2>Franjas Horarias</h2>

        <div id="franjas-container">
            <table class="table table-sm" id="tablaFranjas">
                <thead>
                    <tr>
                        <th>Día de la Semana</th>
                        <th>Hora Inicio</th>
                        <th>Hora Fin</th>
                        <th style="width: 100px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Filas existentes se iteran aquí por Thymeleaf -->
                    <tr th:each="franja, stat : *{franjasHorarias}">
                        <td>
                            <input type="hidden" th:field="*{franjasHorarias[__${stat.index}__].id}" />
                            <input type="hidden" th:name="'franjasHorarias[' + ${stat.index} + '].establecimiento'" th:value="*{id}" /> <!-- Necesario si se crean franjas sin JS y se quiere asociar -->
                            <select th:field="*{franjasHorarias[__${stat.index}__].diaSemana}" class="form-select form-select-sm">
                                <option th:each="dia : ${T(java.time.DayOfWeek).values()}"
                                        th:value="${dia}"
                                        th:text="${#strings.capitalize(#strings.toLowerCase(dia.toString()))}"></option>
                            </select>
                        </td>
                        <td>
                            <input type="time" th:field="*{franjasHorarias[__${stat.index}__].horaInicio}" class="form-control form-control-sm" required />
                        </td>
                        <td>
                            <input type="time" th:field="*{franjasHorarias[__${stat.index}__].horaFin}" class="form-control form-control-sm" required />
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarFranja(this)">Eliminar</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button type="button" class="btn btn-success btn-sm mt-2" onclick="agregarFranja()">Añadir Franja Horaria</button>

        <div class="mt-4"> <!-- Este div ya existe, solo para referencia contextual -->
            <button type="submit" class="btn btn-primary">Guardar Establecimiento</button>
            <a th:href="@{/admin/establecimientos/listado}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
        <!-- Plantilla de Fila para Nuevas Franjas (oculta) -->
        <table style="display:none;">
            <tr id="plantillaFranja">
                <td>
                    <input type="hidden" name="franjasHorarias[REPLACE_INDEX].id" value="" /> <!-- ID es vacío para nuevas -->
                    <input type="hidden" name="franjasHorarias[REPLACE_INDEX].establecimiento" th:value="*{id}" />
                    <select name="franjasHorarias[REPLACE_INDEX].diaSemana" class="form-select form-select-sm">
                        <option th:each="dia : ${T(java.time.DayOfWeek).values()}"
                                th:value="${dia}"
                                th:text="${#strings.capitalize(#strings.toLowerCase(dia.toString()))}"></option>
                    </select>
                </td>
                <td>
                    <input type="time" name="franjasHorarias[REPLACE_INDEX].horaInicio" class="form-control form-control-sm" />
                </td>
                <td>
                    <input type="time" name="franjasHorarias[REPLACE_INDEX].horaFin" class="form-control form-control-sm" />
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarFranja(this)">Eliminar</button>
                </td>
            </tr>
        </table>
        <!-- Fin de Gestión de Franjas Horarias -->
</div>

<!-- Scripts al final del body -->
<script th:src="@{~/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script>
    function renumerarFranjas() {
        const tablaCuerpo = document.getElementById('tablaFranjas').getElementsByTagName('tbody')[0];
        const filas = tablaCuerpo.getElementsByTagName('tr');
        for (let i = 0; i < filas.length; i++) {
            const inputs = filas[i].querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.name) {
                    // Esta regex ahora maneja tanto [REPLACE_INDEX] como índices numéricos (ej. [0], [1], etc.)
                    input.name = input.name.replace(/\[(REPLACE_INDEX|\d+)\]/, '[' + i + ']');
                }
                // Para los campos generados por Thymeleaf que usan th:field, el name se maneja,
                // pero si se clonan, el name puede ser incorrecto si no se actualiza.
                // El id de th:field también se genera con índice, ej: franjasHorarias1.diaSemana
                // y también podría necesitar una actualización similar si se usa para algo en JS.
                // Por ahora, el problema principal es el 'name' para el binding.
                if (input.id && input.id.includes('franjasHorarias')) {
                     // Esta regex asume que los IDs también podrían tener REPLACE_INDEX o un número
                     // ej: franjasHorariasREPLACE_INDEXdiaSemana o franjasHorarias0diaSemana
                     // Pero los IDs generados por th:field son del tipo "franjasHorarias0.diaSemana" (con punto)
                     // Si los IDs clonados de la plantilla no siguen este patrón exacto, esta parte podría necesitar ajuste.
                     // Sin embargo, el error actual es por el 'name', no por el 'id'.
                     // La plantilla usa name="franjasHorarias[REPLACE_INDEX].diaSemana", no th:field, así que no genera IDs automáticos con ese patrón.
                     // Si los IDs de la plantilla se nombraran como "franjasHorarias[REPLACE_INDEX].diaSemana-id", la siguiente línea sería más robusta:
                     // input.id = input.id.replace(/\[(REPLACE_INDEX|\d+)\]/, '[' + i + ']');
                     // Por ahora, mantenemos la lógica original de reemplazo de ID si es necesaria.
                     input.id = input.id.replace(/franjasHorarias(REPLACE_INDEX|\d+)/, 'franjasHorarias' + i);
                }
            });
        }
    }

    function padTime(value) {
        if (!value) return '';
        const [h, m] = value.split(':');
        return h.padStart(2, '0') + ':' + m.padStart(2, '0');
    }
    
    function agregarFranja() {
        const plantilla = document.getElementById('plantillaFranja');
        // Mover la declaración de tablaCuerpo aquí para usarla antes
        const tablaCuerpo = document.getElementById('tablaFranjas').getElementsByTagName('tbody')[0]; 
        const nuevaFila = plantilla.cloneNode(true);

        // --- INICIO DEL NUEVO BLOQUE ---
        let nuevoIndice = tablaCuerpo.rows.length; // Calcula el índice para la nueva fila

        const camposNuevoRenglon = nuevaFila.querySelectorAll('input, select');
        camposNuevoRenglon.forEach(campo => {
            if (campo.name) {
                campo.name = campo.name.replace(/\[REPLACE_INDEX\]/g, '[' + nuevoIndice + ']');
            }
            // Ejemplo de cómo se actualizarían los IDs si también usaran REPLACE_INDEX
            // if (campo.id && campo.name.includes('franjasHorarias')) { // Asegurar que solo se afectan los IDs relevantes
            //     campo.id = campo.id.replace(/REPLACE_INDEX/g, nuevoIndice);
            // }
        });
        // --- FIN DEL NUEVO BLOQUE ---
        
        nuevaFila.id = ''; // Quitar el id de la fila clonada para evitar duplicados

        // Limpiar valores y establecer 'required' en los campos clonados visibles
        const inputsTime = nuevaFila.querySelectorAll('input[type="time"]');
        inputsTime.forEach(input => {
        	input.value = ''; 
            input.required = true; 
        });
        
        tablaCuerpo.appendChild(nuevaFila);
        renumerarFranjas(); // Llamar a renumerarFranjas para asegurar consistencia total
    }

    function eliminarFranja(boton) {
        const fila = boton.closest('tr');
        fila.remove();
        renumerarFranjas();
    }

    // Renumerar al cargar la página por si Thymeleaf y JS interactúan de forma inesperada con los índices
    // o si se planea tener carga dinámica de establecimientos sin recargar página en el futuro.
    // Normalmente no es estrictamente necesario si Thymeleaf genera los índices correctamente al inicio.
    // document.addEventListener('DOMContentLoaded', function() {
    //     renumerarFranjas();
    // });
</script>
</body>
</html>
